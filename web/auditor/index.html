<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAOL Auditor</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --border: #334155;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
      --amber: #f59e0b;
      --font: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 1.25rem; font-weight: 600; }
    header h1 span { color: var(--blue); }
    .status-bar {
      display: flex;
      gap: 1.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .status-bar .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    .dot-green { background: var(--green); }
    .dot-red { background: var(--red); }
    .dot-amber { background: var(--amber); }

    main { padding: 2rem; max-width: 1400px; margin: 0 auto; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .card-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .card-value { font-size: 1.75rem; font-weight: 700; margin-top: 0.25rem; }

    .section { margin-bottom: 2rem; }
    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .connect-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    .connect-form input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem 1rem;
      color: var(--text);
      font-family: var(--font);
      font-size: 0.85rem;
    }
    .connect-form input:focus { outline: none; border-color: var(--blue); }
    button {
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.25rem;
      font-family: var(--font);
      font-size: 0.85rem;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.secondary {
      background: var(--surface);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th {
      text-align: left;
      padding: 0.75rem;
      border-bottom: 2px solid var(--border);
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.7rem;
    }
    td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    tr:hover td { background: rgba(59, 130, 246, 0.05); }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-allow { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .badge-deny { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    .badge-valid { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .badge-invalid { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    .badge-hash { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
    .badge-encrypted { background: rgba(245, 158, 11, 0.15); color: var(--amber); }

    .hash { font-size: 0.7rem; color: var(--text-muted); font-family: var(--font); }
    .hash-short { cursor: help; }

    .checks { list-style: none; }
    .checks li {
      padding: 0.4rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .check-icon { font-size: 0.85rem; }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
    }
    .panel-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem; }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    .empty-state p { margin-top: 0.5rem; font-size: 0.85rem; }

    .detail-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 0.5rem 1rem;
      font-size: 0.8rem;
    }
    .detail-grid dt { color: var(--text-muted); }
    .detail-grid dd { word-break: break-all; }

    #upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    #upload-area:hover { border-color: var(--blue); }
    #upload-area.dragover { border-color: var(--green); background: rgba(34, 197, 94, 0.05); }

    .hidden { display: none; }

    @media (max-width: 768px) {
      header { flex-direction: column; gap: 0.5rem; }
      .connect-form { flex-direction: column; }
      .cards { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1><span>VAOL</span> Auditor</h1>
    <div class="status-bar">
      <span id="connection-status"><span class="dot dot-red"></span>Disconnected</span>
      <span id="tree-status">Tree: --</span>
      <span id="record-count">Records: --</span>
    </div>
  </header>

  <main>
    <div class="connect-form">
      <input type="text" id="server-url" placeholder="VAOL Server URL (e.g., http://localhost:8080)" value="http://localhost:8080">
      <button id="connect-btn" onclick="connectToServer()">Connect</button>
      <button class="secondary" onclick="document.getElementById('bundle-input').click()">Upload Bundle</button>
      <input type="file" id="bundle-input" accept=".json" class="hidden" onchange="handleBundleUpload(event)">
    </div>

    <div class="cards" id="summary-cards">
      <div class="card">
        <div class="card-label">Total Records</div>
        <div class="card-value" id="stat-total">--</div>
      </div>
      <div class="card">
        <div class="card-label">Verified</div>
        <div class="card-value" id="stat-verified" style="color: var(--green)">--</div>
      </div>
      <div class="card">
        <div class="card-label">Invalid</div>
        <div class="card-value" id="stat-invalid" style="color: var(--red)">--</div>
      </div>
      <div class="card">
        <div class="card-label">Chain Status</div>
        <div class="card-value" id="stat-chain">--</div>
      </div>
      <div class="card">
        <div class="card-label">Merkle Tree</div>
        <div class="card-value" id="stat-merkle">--</div>
      </div>
    </div>

    <div class="section" id="verification-section" style="display:none">
      <div class="section-title">Verification Results</div>
      <div class="panel">
        <ul class="checks" id="verification-checks"></ul>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Records</div>
      <div id="records-table-container">
        <div class="empty-state" id="empty-state">
          <p style="font-size: 1.5rem;">&#128274;</p>
          <p>Connect to a VAOL server or upload an audit bundle to begin verification.</p>
        </div>
        <table id="records-table" class="hidden">
          <thead>
            <tr>
              <th>Seq</th>
              <th>Request ID</th>
              <th>Tenant</th>
              <th>Model</th>
              <th>Policy</th>
              <th>Output Mode</th>
              <th>Hash</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="records-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section" id="detail-section" style="display:none">
      <div class="section-title">Record Detail</div>
      <div class="panel" id="record-detail"></div>
    </div>
  </main>

  <script>
    let serverURL = '';
    let currentRecords = [];

    async function connectToServer() {
      const url = document.getElementById('server-url').value.trim().replace(/\/$/, '');
      if (!url) return;

      const btn = document.getElementById('connect-btn');
      btn.disabled = true;
      btn.textContent = 'Connecting...';

      try {
        const healthResp = await fetch(`${url}/v1/health`);
        if (!healthResp.ok) throw new Error(`Health check failed: ${healthResp.status}`);

        serverURL = url;
        updateConnectionStatus(true);

        const recordsResp = await fetch(`${url}/v1/records?limit=100`);
        if (recordsResp.ok) {
          const data = await recordsResp.json();
          displayRecords(data.records || data || []);
        }

        const checkpointResp = await fetch(`${url}/v1/ledger/checkpoint`);
        if (checkpointResp.ok) {
          const cp = await checkpointResp.json();
          document.getElementById('tree-status').textContent = `Tree: ${cp.tree_size || '--'}`;
        }
      } catch (err) {
        updateConnectionStatus(false);
        alert(`Connection failed: ${err.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Connect';
      }
    }

    function updateConnectionStatus(connected) {
      const el = document.getElementById('connection-status');
      if (connected) {
        el.innerHTML = '<span class="dot dot-green"></span>Connected';
      } else {
        el.innerHTML = '<span class="dot dot-red"></span>Disconnected';
      }
    }

    async function handleBundleUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const bundle = JSON.parse(text);
        verifyBundle(bundle);
      } catch (err) {
        alert(`Failed to parse bundle: ${err.message}`);
      }
      event.target.value = '';
    }

    function verifyBundle(bundle) {
      const records = bundle.records || [];
      const checkpoints = bundle.checkpoints || [];
      const metadata = bundle.metadata || {};

      document.getElementById('stat-total').textContent = metadata.total_records || records.length;
      document.getElementById('stat-merkle').textContent = metadata.merkle_tree_size || '--';

      const checks = [];
      let validCount = 0;
      let invalidCount = 0;

      // Verify each record has an envelope with signatures
      for (const rec of records) {
        const env = rec.dsse_envelope || rec.envelope;
        if (env && env.signatures && env.signatures.length > 0) {
          validCount++;
        } else {
          invalidCount++;
        }
      }

      checks.push({
        name: 'Envelope Signatures',
        passed: invalidCount === 0,
        details: `${validCount}/${records.length} records have signatures`
      });

      // Verify chain sequence
      let chainIntact = true;
      for (let i = 1; i < records.length; i++) {
        if (records[i].sequence_number !== records[i-1].sequence_number + 1) {
          chainIntact = false;
          break;
        }
      }
      checks.push({
        name: 'Sequence Continuity',
        passed: chainIntact,
        details: chainIntact ? 'Sequential, no gaps' : 'Gap detected in sequence numbers'
      });

      // Verify checkpoints present
      checks.push({
        name: 'Merkle Checkpoints',
        passed: checkpoints.length > 0,
        details: `${checkpoints.length} checkpoint(s) included`
      });

      // Verify metadata consistency
      const metaValid = metadata.total_records === records.length;
      checks.push({
        name: 'Metadata Consistency',
        passed: metaValid,
        details: metaValid ? 'Metadata matches content' : 'Metadata mismatch'
      });

      // Display checks
      displayVerificationResults(checks);

      document.getElementById('stat-verified').textContent = validCount;
      document.getElementById('stat-invalid').textContent = invalidCount;
      document.getElementById('stat-chain').textContent = chainIntact ? 'Intact' : 'Broken';
      document.getElementById('stat-chain').style.color = chainIntact ? 'var(--green)' : 'var(--red)';

      // Display records
      displayBundleRecords(records);
    }

    function displayVerificationResults(checks) {
      const section = document.getElementById('verification-section');
      section.style.display = '';
      const ul = document.getElementById('verification-checks');
      ul.innerHTML = '';

      for (const check of checks) {
        const li = document.createElement('li');
        const icon = check.passed ? '&#10003;' : '&#10007;';
        const color = check.passed ? 'var(--green)' : 'var(--red)';
        li.innerHTML = `<span class="check-icon" style="color:${color}">${icon}</span>
          <strong>${check.name}</strong>
          <span style="color:var(--text-muted);margin-left:auto">${check.details || ''}</span>`;
        ul.appendChild(li);
      }
    }

    function displayRecords(records) {
      currentRecords = records;
      document.getElementById('empty-state').classList.add('hidden');
      const table = document.getElementById('records-table');
      table.classList.remove('hidden');
      const tbody = document.getElementById('records-tbody');
      tbody.innerHTML = '';

      document.getElementById('stat-total').textContent = records.length;
      document.getElementById('record-count').textContent = `Records: ${records.length}`;

      for (const rec of records) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.onclick = () => showDetail(rec);

        const seq = rec.sequence_number ?? '--';
        const reqId = (rec.request_id || '--').substring(0, 8);
        const tenant = rec.tenant_id || rec.identity?.tenant_id || '--';
        const model = rec.model?.name || '--';
        const policy = rec.policy_context?.policy_decision || '--';
        const mode = rec.output?.mode || '--';
        const hash = (rec.record_hash || rec.integrity?.record_hash || '--').substring(0, 20);

        const policyClass = policy === 'allow' ? 'badge-allow' : policy === 'deny' ? 'badge-deny' : 'badge-allow';
        const modeClass = mode === 'hash_only' ? 'badge-hash' : mode === 'encrypted' ? 'badge-encrypted' : 'badge-hash';

        tr.innerHTML = `
          <td>${seq}</td>
          <td class="hash hash-short" title="${rec.request_id || ''}">${reqId}...</td>
          <td>${tenant}</td>
          <td>${model}</td>
          <td><span class="badge ${policyClass}">${policy}</span></td>
          <td><span class="badge ${modeClass}">${mode}</span></td>
          <td class="hash hash-short" title="${rec.record_hash || rec.integrity?.record_hash || ''}">${hash}...</td>
          <td><span class="badge badge-valid">signed</span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function displayBundleRecords(records) {
      const mapped = records.map((r, i) => ({
        sequence_number: r.sequence_number ?? i,
        request_id: r.request_id || `record-${i}`,
        tenant_id: r.tenant_id,
        record_hash: r.record_hash,
        envelope: r.dsse_envelope || r.envelope,
      }));
      displayRecords(mapped);
    }

    function showDetail(rec) {
      const section = document.getElementById('detail-section');
      section.style.display = '';
      const detail = document.getElementById('record-detail');

      const fields = [
        ['Request ID', rec.request_id],
        ['Sequence', rec.sequence_number],
        ['Tenant', rec.tenant_id || rec.identity?.tenant_id],
        ['Model', rec.model?.name ? `${rec.model.provider}/${rec.model.name}` : '--'],
        ['Policy Decision', rec.policy_context?.policy_decision],
        ['Output Mode', rec.output?.mode],
        ['Record Hash', rec.record_hash || rec.integrity?.record_hash],
        ['Previous Hash', rec.previous_record_hash || rec.integrity?.previous_record_hash],
        ['Timestamp', rec.timestamp],
      ].filter(([_, v]) => v !== undefined && v !== null);

      let html = '<dl class="detail-grid">';
      for (const [label, value] of fields) {
        html += `<dt>${label}</dt><dd>${value}</dd>`;
      }
      html += '</dl>';

      if (rec.envelope) {
        const sigCount = rec.envelope.signatures?.length || 0;
        html += `<div style="margin-top:1rem;font-size:0.8rem;color:var(--text-muted)">
          DSSE Envelope: ${sigCount} signature(s), payload type: ${rec.envelope.payloadType || rec.envelope.payload_type || '--'}
        </div>`;
      }

      detail.innerHTML = html;
      section.scrollIntoView({ behavior: 'smooth' });
    }

    // Keyboard shortcut: Escape to close detail panel
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('detail-section').style.display = 'none';
      }
    });
  </script>
</body>
</html>
